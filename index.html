<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Spotlight Page</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for cards and charts */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50">
        <div class="w-16 h-16 border-4 border-t-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-600">Fetching event data...</p>
    </div>

    <main class="container mx-auto p-4 md:p-8 space-y-12">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Event Spotlight</h1>
            <p class="mt-2 text-gray-600 max-w-2xl mx-auto">An overview of upcoming events, highlighting opportunities with the most availability.</p>
        </header>

        <!-- Highlighted Events Section -->
        <section>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Urgent & Available: Next 7 Days</h2>
            <div id="highlighted-events" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Highlighted event cards will be injected here by JavaScript -->
            </div>
             <div id="no-highlighted-events" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
                <p class="text-gray-500">No high-priority events with many openings in the next 7 days.</p>
            </div>
        </section>

        <!-- Charts Section -->
        <section>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Visual Insights</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md fade-in">
                    <h3 class="font-semibold text-center mb-4">Event Fill Rate (Next 30 Days)</h3>
                    <canvas id="fillRateChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md fade-in">
                    <h3 class="font-semibold text-center mb-4">Overall Slot Availability</h3>
                    <canvas id="availabilityChart"></canvas>
                </div>
            </div>
        </section>

        <!-- All Events Table Section -->
        <section>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">All Upcoming Events</h2>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Event Title</th>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Time</th>
                                <th scope="col" class="px-6 py-3">Availability</th>
                                <th scope="col" class="px-6 py-3">Details</th>
                            </tr>
                        </thead>
                        <tbody id="all-events-table">
                            <!-- All event rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/60 z-40 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 md:p-8 relative">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div class="space-y-4">
                <p><strong class="font-semibold text-gray-600">Date:</strong> <span id="modal-date"></span></p>
                <p><strong class="font-semibold text-gray-600">Time:</strong> <span id="modal-time"></span></p>
                <p><strong class="font-semibold text-gray-600">Availability:</strong> <span id="modal-availability"></span></p>
                <div>
                    <strong class="font-semibold text-gray-600">Details:</strong>
                    <p id="modal-detail" class="mt-1 text-gray-700 whitespace-pre-wrap"></p>
                </div>
                <a id="modal-url" href="#" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                    View Original Event
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // IMPORTANT: Replace with your public Google Sheet URL.
            // It must be in the format: https://docs.google.com/spreadsheets/d/{YOUR_SHEET_ID}/edit?usp=sharing
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit?usp=sharing'; // Example public sheet
            const HIGHLIGHT_OPENINGS_THRESHOLD = 5; // Highlight if more than this many openings
            const HIGHLIGHT_FILL_RATE_THRESHOLD = 0.75; // Or if less than this % full (e.g., 0.75 = 75%)

            const loader = document.getElementById('loader');

            // --- DATA FETCHING & PARSING ---
            function getCsvUrl(sheetUrl) {
                const sheetId = sheetUrl.split('/d/')[1].split('/')[0];
                return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
            }

            async function fetchData() {
                try {
                    const csvUrl = getCsvUrl(GOOGLE_SHEET_URL);
                    const response = await fetch(csvUrl);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    console.error('Failed to fetch or parse sheet data:', error);
                    loader.innerHTML = '<p class="text-red-500">Failed to load data. Please check the Google Sheet URL and sharing permissions.</p>';
                    return [];
                }
            }

            function parseCSV(text) {
                const rows = text.split('\n').map(row => row.trim().slice(1, -1).split('","'));
                const headers = rows.shift();
                return rows.map(row => {
                    const event = {};
                    headers.forEach((header, i) => {
                        // Assuming header names match the required fields
                        event[header.toLowerCase().replace(/\s+/g, '')] = row[i] || '';
                    });
                    return event;
                });
            }

            // --- DATA PROCESSING & RENDERING ---
            function processAndRender(events) {
                if (!events || events.length === 0) {
                    loader.innerHTML = '<p class="text-gray-600">No events found in the sheet.</p>';
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize to start of day

                const processedEvents = events.map(e => {
                    // Assuming date format is like "Saturday, July 05, 2025"
                    const eventDate = new Date(e.date);
                    const openings = parseInt(e.openings, 10) || 0;
                    const totalslots = parseInt(e.totalslots, 10) || 0;
                    const fillRate = totalslots > 0 ? (totalslots - openings) / totalslots : 1;
                    
                    return { ...e, eventDate, openings, totalslots, fillRate };
                }).filter(e => e.eventDate >= today) // Only show future events
                  .sort((a, b) => a.eventDate - b.eventDate); // Sort by date

                renderHighlightedEvents(processedEvents, today);
                renderAllEventsTable(processedEvents);
                renderCharts(processedEvents, today);

                loader.classList.add('hidden');
            }

            function renderHighlightedEvents(events, today) {
                const highlightedContainer = document.getElementById('highlighted-events');
                const noEventsMessage = document.getElementById('no-highlighted-events');
                
                const sevenDaysFromNow = new Date(today);
                sevenDaysFromNow.setDate(today.getDate() + 7);

                const highlighted = events.filter(e => 
                    e.eventDate <= sevenDaysFromNow &&
                    (e.openings >= HIGHLIGHT_OPENINGS_THRESHOLD || (e.totalslots > 0 && e.fillRate < HIGHLIGHT_FILL_RATE_THRESHOLD))
                );

                if (highlighted.length === 0) {
                    noEventsMessage.classList.remove('hidden');
                    return;
                }

                highlightedContainer.innerHTML = highlighted.map((event, index) => `
                    <div class="bg-white p-5 rounded-lg shadow-lg border-l-4 border-amber-400 fade-in" style="animation-delay: ${index * 100}ms;">
                        <h4 class="font-bold text-lg text-gray-800">${event.title}</h4>
                        <p class="text-sm text-gray-500">${event.eventDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="text-sm text-gray-500">${event.time}</p>
                        <div class="mt-3">
                            <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded">
                                ${event.openings} of ${event.totalslots} Open
                            </span>
                        </div>
                        <button data-event-index="${events.indexOf(event)}" class="details-btn mt-4 text-indigo-600 hover:text-indigo-800 font-semibold text-sm">View Details &rarr;</button>
                    </div>
                `).join('');
            }

            function renderAllEventsTable(events) {
                const tableBody = document.getElementById('all-events-table');
                tableBody.innerHTML = events.map((event, index) => `
                    <tr class="bg-white border-b hover:bg-gray-50 fade-in" style="animation-delay: ${index * 20}ms;">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${event.title}</th>
                        <td class="px-6 py-4">${event.eventDate.toLocaleDateString()}</td>
                        <td class="px-6 py-4">${event.time}</td>
                        <td class="px-6 py-4">
                             <span class="font-semibold ${event.openings > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${event.openings} / ${event.totalslots}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <button data-event-index="${index}" class="details-btn font-medium text-indigo-600 hover:underline">Details</button>
                        </td>
                    </tr>
                `).join('');
                
                // Add event listeners for the new detail buttons
                addDetailButtonListeners(events);
            }

            function renderCharts(events, today) {
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setDate(today.getDate() + 30);

                const upcomingEvents = events.filter(e => e.eventDate <= thirtyDaysFromNow && e.totalslots > 0);
                
                // Fill Rate Chart
                const fillRateCtx = document.getElementById('fillRateChart').getContext('2d');
                new Chart(fillRateCtx, {
                    type: 'bar',
                    data: {
                        labels: upcomingEvents.map(e => e.title),
                        datasets: [{
                            label: 'Fill Rate %',
                            data: upcomingEvents.map(e => e.fillRate * 100),
                            backgroundColor: upcomingEvents.map(e => e.fillRate > 0.8 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(34, 197, 94, 0.6)'),
                            borderColor: upcomingEvents.map(e => e.fillRate > 0.8 ? 'rgba(239, 68, 68, 1)' : 'rgba(34, 197, 94, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false } }
                    }
                });

                // Availability Chart
                const totalOpenings = events.reduce((sum, e) => sum + e.openings, 0);
                const totalFilled = events.reduce((sum, e) => sum + (e.totalslots - e.openings), 0);
                
                const availabilityCtx = document.getElementById('availabilityChart').getContext('2d');
                new Chart(availabilityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Available Spots', 'Filled Spots'],
                        datasets: [{
                            data: [totalOpenings, totalFilled],
                            backgroundColor: ['rgba(5, 150, 105, 0.7)', 'rgba(220, 38, 38, 0.7)'],
                            borderColor: ['rgba(5, 150, 105, 1)', 'rgba(220, 38, 38, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }
            
            // --- MODAL & EVENT LISTENERS ---
            function addDetailButtonListeners(events) {
                const modal = document.getElementById('event-modal');
                
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('details-btn')) {
                        const eventIndex = e.target.dataset.eventIndex;
                        const event = events[eventIndex];
                        
                        document.getElementById('modal-title').textContent = event.title;
                        document.getElementById('modal-date').textContent = event.eventDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        document.getElementById('modal-time').textContent = event.time;
                        document.getElementById('modal-availability').textContent = `${event.openings} of ${event.totalslots} slots available`;
                        document.getElementById('modal-detail').textContent = event.detail;
                        document.getElementById('modal-url').href = event.url;
                        
                        modal.classList.remove('hidden');
                    }
                });
            }
            
            const modal = document.getElementById('event-modal');
            const closeModalBtn = document.getElementById('close-modal');
            
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { // Close if clicking on the backdrop
                    modal.classList.add('hidden');
                }
            });

            // --- INITIALIZE ---
            fetchData().then(processAndRender);
        });
    </script>
</body>
</html>
